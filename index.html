<html>
  <head>
    <title>Together</title>
    <meta name="description" content="learn together">
    <meta name="author" content="Kris">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <style>
#url {
  min-width: 70%;
}

.imgpreview {
  width: 40%;
  border: 1px solid black;
}

@media screen and (max-width: 600px) {
  .desktop {
    visibility: hidden;
    display: none;
  }
}
  </style>
  <link rel="stylesheet" href="css/style.css">
  <script>
    const peerImages = {}

    function broadcastAllImages () {
      getOurImagesPromise().then((images) => {
        console.log('Sending Images to client', images)
        TogetherJS.send({type: 'setImages', images})
      })
    }

    var TogetherJSConfig_dontShowClicks = ".cd-panel"
    var TogetherJSConfig_ignoreForms = ['input[type=file]']
    var TogetherJSConfig_cloneClicks = "#b" // clone clicks on load image button only
    var TogetherJSConfig_suppressJoinConfirmation = true
    var TogetherJSConfig_suppressInvite = true
    var TogetherJSConfig_on_ready = function () {
      var session = TogetherJS.require("session");
      console.log({session});
      broadcastAllImages()
      TogetherJS.hub.on('setImageUrl', msg => setImageUrl(msg.url, true))
      TogetherJS.hub.on('imagesSet', msg => console.log('imagesSet', {msg}))
      TogetherJS.hub.on('togetherjs.form-init', loadMainImage)
      TogetherJS.hub.on('togetherjs.peer-update', msg => {
        const peerInfo = peerImages[msg.clientId]
        peerImages[msg.clientId] = { images: peerInfo.images, name: msg.name }
      })

      TogetherJS.hub.on('setImages', msg => {
        peerImages[msg.clientId] = { images: msg.images, name: msg.peer.name }
        console.log('setImages', {msg})
        TogetherJS.send({type: 'imagesSet', qty: msg.images.length});
      })
      TogetherJS.hub.on('togetherjs.hello', msg => {
        // FIXME sent only to hello client, can be done?
        broadcastAllImages()
      })

    }
  </script>
  <script async src="https://togetherjs.com/togetherjs-min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/lozad"></script>
  <script defer src="./panel.js"></script>
  <body>
    <main class="cd-main-content">
      <button
        id="start-togetherjs" type="button" class="desktop" 
                                            onclick="TogetherJS.startTarget=this; TogetherJS(this); return false"
                                            data-end-togetherjs-html="End TogetherJS">
        Start TogetherJS
      </button>
      <input type="url" name="url" id="url"
                                   placeholder="https://site.com/path/to/image.jpg"
                                   required>
      <button id="b">Load image</button>
      <a href="#0" class="js-cd-panel-trigger desktop" data-panel="main">
        Images
      </a>
      <a href="#1" class="js-cd-panel-trigger desktop" data-panel="story">
        Story
      </a>
      <br>

      <img src="" id="image">
    </main>
    <div class="cd-panel cd-panel--from-right js-cd-panel-main">
      <header class="cd-panel__header">
        <h1>
          Images
          <input style='margin-left:30px;' id="browse" type="file" onchange="addFiles()" multiple>
        </h1>
        <a href="#0" class="cd-panel__close js-cd-close">Close</a>
      </header>

      <div class="cd-panel__container">
        <div id="previews" class="cd-panel__content">
          <p>Loading...</p>
        </div>
      </div>
    </div> 
    <div class="cd-panel cd-panel--from-right js-cd-panel-story">
      <header class="cd-panel__header">
        <h1>Story</h1>
        <a href="#1" class="cd-panel__close js-cd-close">Close</a>
      </header>

      <div class="cd-panel__container">
        <div id="story" class="cd-panel__content">
          <p>Loading...</p>
        </div>
      </div>
    </div> 
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script>
      function addFiles() {
        const input = document.querySelector('input[type=file]')
        const files = input.files
        function readAndPreview(file) {

          // Make sure `file.name` matches our extensions criteria
          if ( /\.(jpe?g|png|gif)$/i.test(file.name) ) {
            const reader = new FileReader();

            reader.onload = function (e) {
              const name = e.timeStamp.toString()
              const src = this.result;
              console.log({name, src})
              add(name, src).then(
                // TODO previewAllImages only after all have been saved
                () => previewAllImages()
              )
              console.log({e})
            }

            reader.readAsDataURL(file);
          }

        }

        if (files) {
          [].forEach.call(files, readAndPreview);
        }

        input.value = null
      }

      function loadMainImage () {
        const imageInput = document.getElementById("url");
        const image = document.getElementById("image");
        image.src = ""
        if (imageInput.value) {
          image.onload = () => TogetherJS.send({type: 'imageLoaded', url: imageInput.value});
          image.dataset.src =  imageInput.dataset.src
          image.src = imageInput.value;
        }
      }
      // add handler to img button
      document.getElementById("b").addEventListener("click", e => {
        loadMainImage()
      });


      // initialise dexie
      var db = new Dexie("images");
      db.version(1).stores({
        images: 'name,url'
      });

      // db.images.put({name: 'Банковские операции', url:'http://bidstrup.ru/images/comicses/0908.gif'})
      // db.images.put({name: 'Плата за мир', url:'http://bidstrup.ru/images/comicses/0920.gif'})
      // db.images.put({name: 'car', url:'https://i.pinimg.com/474x/ed/35/fb/ed35fbefa01c7ea3015a0ef7c9201eb8--adult-coloring-coloring-books.jpg'})

      const proxyUrl = (url, cb = (id) => id) => url.startsWith('http')
        ? cb(`https://images.weserv.nl/?url=${url}`)
        : url

      function setImageUrl (url, surpress) {
        const imageInput = document.getElementById("url");
        imageInput.dataset.src = url
        imageInput.value = proxyUrl(url);
        loadMainImage()
        if (!surpress)
          TogetherJS.send({type: 'setImageUrl', url})
      }

      /* console functions */
      function load (name) {
        db.images.get(name).then(
          image => {
            if (!image) {
              console.log('Not found [' + name + ']')
              return
            }
            setImageUrl(image.url)
          }
        )
      }

      function each () {
        db.images.each(row => console.log(row.name, row.url))
      }

      function add (name, url) {
        return db.images.get(name).then(
          image => {
            if (image) {
              console.log(`image [${name}] already exists with url [${image.url}]`)
              console.log({image})
            } else {
              image = {name}
            }

            image.url = url
            return db.images.put(image)
          }
        )
      }

      function addStory (name, lang, story) {
        db.images.get(name).then(
          image => {
            if (!image) {
              console.log('image does not exist [' + name + ']')
              return
            }

            image.story = (image.story || {})
            image.story[lang] = story
            db.images.put(image)
          }
        )
      }
      /* end console functions */

      function imageClicked (el) {
        console.log({el})
        if (el) setImageUrl(el.dataset.src)
        return false
      }

      function loadStory () {
        const src = document.getElementById("image").dataset.src;
        const storyContainer = document.getElementById('story')
        getImagesPromise().then(
          (images) => {
            const storyImage = images.find(image => image.url == src) || {}
            const stories = storyImage.story || {}
            console.log('stories', stories)
            html = Object.keys(stories).map(lang => `<p class="${lang}">${stories[lang]}</p>`).join("\n")
            storyContainer.innerHTML = html
          }
        )
      }

      // OurImages | TheirImages :: [Image]
      // getImagesPromise :: global -> OurImages | TheirImages
      function getImagesPromise () {
        return getOurImagesPromise()
      }

      // getOurImagesPromise :: global -> OurImages
      function getOurImagesPromise () {
        const images = []
        return db.images.each(row => images.push(row)).then(() => images)
      }

    </script>
  </body>
</html>


